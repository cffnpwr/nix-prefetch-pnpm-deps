---
status: accepted
date: 2026-02-13
---

# ADR-0005: 全アプリケーションコードのinternal/配下への配置

> 遡及的に記録

## コンテキスト

本プロジェクトはpnpm依存関係をNixpkgs向けにプリフェッチするCLIツールである。
ライブラリとして外部から利用されることは想定していない。

Goではモジュール内の`internal/`ディレクトリ配下のパッケージは、そのモジュール外からインポートできないという言語仕様がある。
コードの公開範囲を制御するための構成を決める必要があった。

## 検討した選択肢

### 選択肢1: 全コードをinternal/配下に配置

`main.go`のみをルートに置き、すべてのアプリケーションコードを`internal/`配下に配置する。
`main.go`は`internal/cli.Execute()`を呼ぶだけの最小限のエントリーポイントとする。

#### 良い点

- 外部からのインポートを言語仕様レベルで防止できる
- 内部実装の変更が外部に影響しないことが保証される

#### 悪い点

- パッケージのインポートパスが長くなる（`internal/lockfile/errors`など）

### 選択肢2: ルートパッケージやpkg/に配置

コードをルートパッケージや`pkg/`ディレクトリに配置し、外部からインポート可能にする。

#### 良い点

- インポートパスが短い
- 将来ライブラリとして公開する場合に移行不要

#### 悪い点

- 意図せず外部から依存される可能性がある
- 内部実装の変更が破壊的変更になりうる

### 選択肢3: cmd/パターン

`cmd/nix-prefetch-pnpm-deps/main.go`にエントリーポイントを置く。

#### 良い点

- 複数のCLIバイナリを持つプロジェクトで一般的なパターン

#### 悪い点

- 単一バイナリしか持たない本プロジェクトでは不要な階層が増える

## 決定

全アプリケーションコードを`internal/`配下に配置する。

本プロジェクトはCLIツールであり、ライブラリとして公開する予定はない。
`internal/`による可視性制限は意図しない外部依存を言語仕様レベルで防止する。
単一バイナリのため`cmd/`パターンは不要。

## 結果

### 良い影響

- 内部実装を自由に変更でき、外部互換性を考慮する必要がない
- パッケージ構成の意図が`internal/`ディレクトリ名から明確に伝わる

### 悪い影響

- 将来ライブラリとして一部機能を公開したくなった場合、パッケージの移動が必要になる