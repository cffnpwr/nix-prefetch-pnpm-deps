---
status: accepted
date: 2026-02-13
---

# ADR-0002: afero.Fsによるファイルシステム抽象化

> 遡及的に記録

## コンテキスト

本プロジェクトはpnpm-lock.yamlの読み込み、pnpmストアの操作、tarball作成など多くのファイルシステム操作を行う。
これらの操作を含むコードをテストする際、実際のファイルシステムに依存するとテストが遅くなり環境依存の問題も発生する。

ファイルシステム操作を抽象化し、テスト時にインメモリファイルシステムに差し替え可能にする仕組みが必要だった。

## 検討した選択肢

### 選択肢1: afero.Fs

`github.com/spf13/afero`が提供する`afero.Fs`インターフェースをすべてのファイルシステム操作に使用する。
コンストラクタや関数の引数として`afero.Fs`を受け取る。

#### 良い点

- 十分な機能を持つインターフェースが提供されており自前で定義する必要がない
- `afero.NewMemMapFs()`でテスト時のインメモリFS差し替えが容易
- Goエコシステムで広く使われている

#### 悪い点

- 外部依存が増える
- `os`パッケージのすべてのAPIをカバーしているわけではない

### 選択肢2: osパッケージの直接使用

標準ライブラリの`os`パッケージを直接使用する。

#### 良い点

- 外部依存なし
- Go標準のAPI

#### 悪い点

- テスト時に実際のファイルシステムが必要（一時ディレクトリなど）
- テストが遅くなる
- 環境依存の問題が発生しやすい

### 選択肢3: 自前のインターフェース定義

必要な操作のみを定義した独自の`FileSystem`インターフェースを作成する。

#### 良い点

- 必要最小限のインターフェースにできる
- 外部依存なし

#### 悪い点

- 実装・保守コストがかかる
- ヘルパー関数（`WriteFile`等）も自前実装が必要

## 決定

`afero.Fs`を全ファイルシステム操作に使用する。
`os`パッケージの直接使用は`main.go`を除いて禁止する。

aferoは必要十分なインターフェースと`MemMapFs`によるインメモリ実装を提供しており自前実装のコストを避けられる。
本プロジェクトの全パッケージ（`lockfile`、`pnpm`、`store`）がファイルシステム操作を行うため、統一的な抽象化の恩恵が大きい。

## 結果

### 良い影響

- テストが高速かつ環境非依存に
- `afero.NewMemMapFs()`と`setupFs`パターンによりテストケースごとに独立したファイルシステム状態を構築可能

### 悪い影響

- 全関数の第一引数に`afero.Fs`を渡す必要があり、シグネチャがやや冗長に
