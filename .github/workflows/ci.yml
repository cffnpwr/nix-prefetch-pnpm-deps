name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format-check:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Nix
        uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - name: Check formatting
        run: nix develop --command treefmt --fail-on-change

  lint:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Nix
        uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - name: Run golangci-lint
        run: nix develop --command golangci-lint run ./...

  unit-test:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Nix
        uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - name: Run unit tests
        run: nix develop --command go test ./...

  integration-test:
    if: github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            nix-system: x86_64-linux
          - runner: ubuntu-24.04-arm
            nix-system: aarch64-linux
          - runner: macos-15
            nix-system: aarch64-darwin
          - runner: macos-15
            nix-system: x86_64-darwin
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Nix
        uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - name: Run integration tests
        run: nix develop --system ${{ matrix.nix-system }} --command go test -tags integration -v -timeout 30m ./test/integration/
