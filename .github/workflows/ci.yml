name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format-check:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Nix
        uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - name: Check formatting
        run: nix develop --command treefmt --fail-on-change

  lint:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Nix
        uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - name: Run golangci-lint
        run: nix develop --command golangci-lint run ./...

  unit-test:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Nix
        uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - name: Run unit tests
        run: nix develop --command go test ./...

  integration-test:
    if: >-
      github.event_name == 'push' ||
      contains(github.event.pull_request.labels.*.name, 'autorelease: pending')
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            nix-system: x86_64-linux
          - runner: ubuntu-24.04-arm
            nix-system: aarch64-linux
          - runner: macos-15
            nix-system: aarch64-darwin
          - runner: macos-15
            nix-system: x86_64-darwin
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Nix
        uses: DeterminateSystems/determinate-nix-action@89ab342bd48ff7318caf8d39d6a330c7b1df8f2f # v3.15.2

      - name: Run integration tests
        run: nix develop --system ${{ matrix.nix-system }} --command go test -tags integration -v -timeout 30m ./test/integration/

  is-check-passed:
    name: Check all checks passed
    needs:
      - format-check
      - lint
      - unit-test
      - integration-test
    if: always()
    runs-on: ubuntu-24.04
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.format-check.result }}" != "success" ]]; then
            echo "format check failed"
            exit 1
          fi

          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "lint check failed"
            exit 1
          fi

          if [[ "${{ needs.unit-test.result }}" != "success" ]]; then
            echo "unit test failed"
            exit 1
          fi

          # If integration test was expected to run, check the result
          if [[ "${{ needs.integration-test.result }}" != "success" && "${{ needs.integration-test.result }}" != "skipped" ]]; then
            echo "integration test failed"
            exit 1
          fi

          echo "all checks passed"
